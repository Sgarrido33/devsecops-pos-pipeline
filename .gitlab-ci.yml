image: docker:latest

services:
  - docker:dind

variables:
  AUTO_DEVOPS_ENABLED: "false"
  IMAGE_TAG: "$DOCKER_USER/proyecto-devsecops:latest"
  # Optimizamos pip para que use cachÃ©
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

stages:
  - prepare        
  - test-backend
  - build-backend
  - Secret-Scanning
  - IAC-Scanning-Checkov
  - SCA(trivy)
  - SAST(Semgrep)
  - DAST(OWASP)
  - deploy

# =====================================================
# 1. PREPARE FRONTEND (Instala y guarda en CachÃ©)
# =====================================================
prepare_frontend:
  stage: prepare
  image: node:18-alpine
  script:
    - echo "ðŸ“¦ Instalando dependencias Frontend..."
    - cd frontend
    - npm ci --prefer-offline --no-audit
    - echo "âœ… Dependencias Frontend listas."
  # Guardamos 'node_modules' en cachÃ© para que otros jobs lo usen
  cache:
    key:
      files:
        - frontend/package-lock.json
    paths:
      - frontend/node_modules/
    policy: pull-push

# =====================================================
# 2. PREPARE BACKEND (Crea entorno virtual y guarda)
# =====================================================
prepare_backend:
  stage: prepare
  image: python:3.10-slim
  script:
    - echo "ðŸ Preparando entorno virtual Backend..."
    - cd backend
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
    - pip install pytest cryptography gunicorn
    - echo "âœ… Dependencias Backend listas en virtualenv."
  # Guardamos la carpeta 'venv' y el cachÃ© de pip
  cache:
    key:
      files:
        - backend/requirements.txt
    paths:
      - backend/venv/
      - .cache/pip/
    policy: pull-push

# =====================================================
# 3. TEST BACKEND (Usa el cachÃ© del paso anterior)
# =====================================================
unit_tests_backend:
  stage: test-backend
  image: python:3.10-slim
  services:
    - name: mysql:5.7
      alias: mysql
  variables:
    MYSQL_HOST: "mysql"
    MYSQL_USER: "test_user"
    MYSQL_PASSWORD: "test_password"
    MYSQL_DATABASE: "test_db"
    MYSQL_ROOT_PASSWORD: "root_password" 
  # Recuperamos el cachÃ© (solo lectura)
  cache:
    key:
      files:
        - backend/requirements.txt
    paths:
      - backend/venv/
      - .cache/pip/
    policy: pull
  script:
    - echo "ðŸ§ª Ejecutando pruebas unitarias..."
    - cd backend
    # Activamos el entorno virtual creado en 'prepare_backend'
    - source venv/bin/activate 
    - export PYTHONPATH=.
    - pytest tests/ --junitxml=../report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml
    paths:
      - report.xml

# =====================================================
# 4. BUILD BACKEND (Dry Run)
# =====================================================
# Nota: Docker build NO puede usar el cachÃ© de CI, 
# debe instalar sus cosas dentro de la imagen.
build_image_dry_run:
  stage: build-backend
  script:
    - echo "ðŸ³ Verificando construcciÃ³n de la imagen..."
    - docker build -t test-backend .
    - echo "âœ… Build exitoso."

# =====================================================
# 5. SECRET SCANNING
# =====================================================
scan_secrets_gitleaks:
  stage: Secret-Scanning
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - "gitleaks detect --source=. -v --report-path gitleaks-report.json"
  allow_failure: true
  artifacts:
    paths: [gitleaks-report.json]

scan_secrets_trufflehog:
  stage: Secret-Scanning
  image: ubuntu:22.04
  before_script:
    - apt-get update -y && apt-get install -y git curl jq
  script:
    - curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b .
    - "./trufflehog filesystem . --results=verified,unknown --json > trufflehog-report.json || true"
  allow_failure: true
  artifacts:
    paths: [trufflehog-report.json]

# =====================================================
# 6. IAC SCANNING
# =====================================================
iac_scan_checkov:
  stage: IAC-Scanning-Checkov
  image:
    name: bridgecrew/checkov:latest
    entrypoint: [""]
  script:
    - "checkov -d . -o json > checkov-report.json || true"
    - cat checkov-report.json
  allow_failure: true
  artifacts:
    paths: [checkov-report.json]

# =====================================================
# 7. SCA (TRIVY)
# =====================================================
sca_trivy_scan:
  stage: SCA(trivy)
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - "trivy fs . --format json --output trivy-report.json"
  allow_failure: true
  artifacts:
    paths: [trivy-report.json]

# =====================================================
# 8. SAST (SEMGREP)
# =====================================================
sast_semgrep_scan:
  stage: SAST(Semgrep)
  image:
    name: returntocorp/semgrep:latest
    entrypoint: [""]
  script:
    - rm -rf /src 2>/dev/null || true
    - ln -s $CI_PROJECT_DIR /src
    - "semgrep scan --config=auto --json --output=semgrep-report.json ."
  allow_failure: true
  artifacts:
    paths: [semgrep-report.json]

# =====================================================
# 9. DAST (OWASP ZAP)
# =====================================================
dast_owasp_zap:
  stage: DAST(OWASP)
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_NETWORK: "app-net"
  script:
    - echo "ðŸš€ Iniciando entorno DAST..."
    - docker network create $DOCKER_NETWORK
    # Backend
    - |
      docker run -d --name web --network $DOCKER_NETWORK \
      -v $PWD/backend:/app -w /app \
      python:3.10-slim \
      sh -c "pip install -r requirements.txt && pip install gunicorn && gunicorn -w 4 -b 0.0.0.0:5000 wsgi:app"
    - sleep 10
    # Nginx
    - |
      docker run -d --name nginx-proxy --network $DOCKER_NETWORK \
      -p 80:80 \
      -v $PWD/nginx/nginx.conf:/etc/nginx/conf.d/default.conf \
      nginx:latest
    - sleep 5
    # Ataque ZAP
    - echo "ðŸ”¥ Atacando..."
    - touch zap-nginx-report.html
    - chmod 666 zap-nginx-report.html
    - |
      docker run --rm --network $DOCKER_NETWORK \
      -v $PWD:/zap/wrk:rw \
      zaproxy/zap-stable \
      zap-baseline.py \
      -t http://nginx-proxy \
      -r zap-nginx-report.html || true
    - docker rm -f nginx-proxy web
    - docker network rm $DOCKER_NETWORK
  artifacts:
    when: always
    paths:
      - zap-nginx-report.html
    expire_in: 1 week

# =====================================================
# 10. DEPLOY
# =====================================================
deploy_to_dockerhub:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "ðŸšš Desplegando..."
    - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
    - "echo âœ… Imagen publicada: $IMAGE_TAG"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"